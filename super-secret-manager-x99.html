<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sudip Party</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-sidebar {
            width: 250px;
            background: #333;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .admin-sidebar h3 {
            color: #ff4757;
            text-align: center;
            margin-bottom: 30px;
        }

        .admin-sidebar button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: none;
            background: transparent;
            color: #ccc;
            text-align: left;
            cursor: pointer;
            font-size: 1rem;
        }

        .admin-sidebar button:hover,
        .admin-sidebar button.active {
            background: #ff4757;
            color: white;
            padding-left: 20px;
            transition: 0.3s;
        }

        .admin-content {
            flex: 1;
            padding: 30px;
            background: #f4f4f4;
        }

        .admin-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .admin-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .admin-gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            height: 150px;
            border: 1px solid #ccc;
        }

        .admin-gallery-item img,
        .admin-gallery-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .delete-overlay {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            text-align: center;
            cursor: pointer;
            padding: 5px;
        }
    </style>
</head>

<body>

    <div id="loginSection" class="login-container" style="margin: 100px auto; max-width: 400px; display: block;">
        <h2 style="color: #ff4757; text-align:center;">Admin Login</h2>
        <p id="loginError" class="error-msg" style="color:red; text-align:center; display:none;"></p>
        <form id="loginForm"
            style="display:flex; flex-direction:column; gap:10px; padding:20px; background:white; box-shadow:0 0 10px rgba(0,0,0,0.1); border-radius:8px;">
            <input type="email" id="adminEmail" placeholder="Admin Email" style="padding:10px;" required>
            <input type="password" id="adminPass" placeholder="Password" style="padding:10px;" required>
            <button type="submit" class="btn-login" id="loginBtn"
                style="padding:10px; background:#ff4757; color:white; border:none; cursor:pointer;">Login</button>
        </form>
    </div>

    <div id="dashboardSection" style="display: none; display: flex;">
        <div class="admin-sidebar">
            <h3>Sudip Admin</h3>
            <button onclick="switchTab('gallery')" class="active">Manage Gallery</button>
            <button onclick="switchTab('reviews')">Manage Reviews</button>
            <button onclick="logout()" style="margin-top: 50px; background: #c0392b;">Logout</button>
        </div>

        <div class="admin-content">

            <div id="galleryTab">
                <h2>Manage Gallery</h2>
                <div class="admin-card">
                    <h4>Upload New Photo/Video</h4>
                    <input type="file" id="adminFile" accept="image/*,video/*" style="margin: 10px 0;">
                    <div id="uploadStatus" style="display:none; color: green;">Uploading...</div>
                    <button onclick="uploadAdminMedia()"
                        style="padding: 10px 20px; background: #2ed573; border: none; color: white; cursor: pointer;">Upload</button>
                </div>
                <div id="adminGalleryGrid" class="admin-gallery-grid"></div>
            </div>

            <div id="reviewsTab" style="display: none;">
                <h2>Manage Reviews</h2>

                <div class="admin-card">
                    <h4>Add Manual Review (From Google/WhatsApp)</h4>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <input type="text" id="manualName" placeholder="Client Name (e.g. 'Amit via Google')"
                            style="padding: 10px;">
                        <textarea id="manualReview" placeholder="Paste the review text here..." rows="3"
                            style="padding: 10px;"></textarea>
                        <select id="manualRating" style="padding: 10px;">
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                        </select>
                        <button onclick="addManualReview()"
                            style="padding: 10px; background: #ff4757; color: white; border: none; cursor: pointer;">Add
                            Review</button>
                    </div>
                </div>

                <h3>Recent Reviews</h3>
                <div id="adminReviewsList" style="display: flex; flex-direction: column; gap: 10px;">
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCDuau7j4CyfotHfMr0svnDY8hp10F3f3M",
            authDomain: "sudipparty-24d31.firebaseapp.com",
            projectId: "sudipparty-24d31",
            storageBucket: "sudipparty-24d31.firebasestorage.app",
            messagingSenderId: "372149822854",
            appId: "1:372149822854:web:ca02d0536a604a31703807"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- AUTH LOGIC ---
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const loginForm = document.getElementById('loginForm');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'flex';
                loadAdminGallery();
            } else {
                loginSection.style.display = 'block';
                dashboardSection.style.display = 'none';
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            signInWithEmailAndPassword(auth, email, pass)
                .catch(err => document.getElementById('loginError').innerText = err.message);
        });

        window.logout = () => signOut(auth);

        // --- TABS ---
        window.switchTab = (tabName) => {
            document.getElementById('galleryTab').style.display = (tabName === 'gallery') ? 'block' : 'none';
            document.getElementById('reviewsTab').style.display = (tabName === 'reviews') ? 'block' : 'none';

            // Highlight active button
            const buttons = document.querySelectorAll('.admin-sidebar button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (tabName === 'reviews') loadAdminReviews();
        };

        // --- GALLERY ---
        window.uploadAdminMedia = async () => {
            const file = document.getElementById('adminFile').files[0];
            if (!file) return alert("Select a file first!");

            const storageRef = ref(storage, 'gallery/' + Date.now() + '_' + file.name);
            const uploadTask = uploadBytesResumable(storageRef, file);

            document.getElementById('uploadStatus').style.display = 'block';

            uploadTask.on('state_changed', null, null, async () => {
                const url = await getDownloadURL(uploadTask.snapshot.ref);
                await addDoc(collection(db, "gallery"), {
                    mediaURL: url,
                    mediaType: file.type.startsWith('video') ? 'video' : 'image',
                    createdAt: serverTimestamp()
                });
                document.getElementById('uploadStatus').style.display = 'none';
                alert("Uploaded Successfully!");
                loadAdminGallery();
            });
        };

        async function loadAdminGallery() {
            const grid = document.getElementById('adminGalleryGrid');
            grid.innerHTML = "Loading...";
            const q = query(collection(db, "gallery"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            grid.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                const content = data.mediaType === 'video' ? `<video src="${data.mediaURL}" muted></video>` : `<img src="${data.mediaURL}">`;
                grid.innerHTML += `
                    <div class="admin-gallery-item">
                        ${content}
                        <div class="delete-overlay" onclick="deleteData('gallery', '${doc.id}')">Delete</div>
                    </div>`;
            });
        }

        // --- REVIEWS (Manual Add) ---
        window.addManualReview = async () => {
            const name = document.getElementById('manualName').value;
            const review = document.getElementById('manualReview').value;
            const rating = document.getElementById('manualRating').value;

            if (!name || !review) return alert("Please fill Name and Review");

            await addDoc(collection(db, "reviews"), {
                name: name,
                review: review,
                rating: parseInt(rating),
                createdAt: serverTimestamp(),
                mediaType: 'none', // No image for manual text reviews
                mediaURL: null
            });

            alert("Review Added Successfully!");
            document.getElementById('manualName').value = "";
            document.getElementById('manualReview').value = "";
            loadAdminReviews(); // Refresh list
        };

        async function loadAdminReviews() {
            const list = document.getElementById('adminReviewsList');
            list.innerHTML = "Loading...";
            const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            list.innerHTML = "";
            snapshot.forEach(doc => {
                const data = doc.data();
                list.innerHTML += `
                    <div style="background:white; padding:10px; border-radius:5px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>${data.name}</strong> (${data.rating} Stars)<br>
                            <small>${data.review.substring(0, 50)}...</small>
                        </div>
                        <button onclick="deleteData('reviews', '${doc.id}')" style="background:red; color:white; border:none; padding:5px 10px; cursor:pointer;">Delete</button>
                    </div>`;
            });
        }

        // --- GLOBAL DELETE ---
        window.deleteData = async (col, id) => {
            if (confirm("Delete this item?")) {
                await deleteDoc(doc(db, col, id));
                if (col === 'gallery') loadAdminGallery();
                if (col === 'reviews') loadAdminReviews();
            }
        };

    </script>
</body>

</html>