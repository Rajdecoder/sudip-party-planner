<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sudip Party</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="loginSection" class="login-container" style="margin: 100px auto; max-width: 400px; display: block;">
        <h2 style="color: #ff4757; text-align:center;">Admin Login</h2>
        <p id="loginError" class="error-msg" style="color:red; text-align:center; display:none;"></p>
        <form id="loginForm" style="display:flex; flex-direction:column; gap:10px; padding:20px;">
            <input type="email" id="adminEmail" placeholder="Admin Email" style="padding:10px;" required>
            <input type="password" id="adminPass" placeholder="Password" style="padding:10px;" required>
            <button type="submit" class="btn-login" id="loginBtn" style="padding:10px; background:#ff4757; color:white; border:none; cursor:pointer;">Login</button>
        </form>
    </div>

    <div id="dashboardSection" class="admin-layout" style="display: none;">
        
        <div class="admin-sidebar">
            <h2>Admin Panel</h2>
            <button class="menu-btn active" onclick="showTab('reviews')"><i class="fas fa-comments"></i> Manage Reviews</button>
            <button class="menu-btn" onclick="showTab('gallery')"><i class="fas fa-images"></i> Manage Gallery</button>
            <button class="menu-btn logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <div class="admin-content">
            
            <div id="tab-reviews">
                <h1>Manage Reviews</h1>
                <div style="overflow-x: auto; background: white; padding: 20px; border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background:#ddd; text-align:left;">
                                <th style="padding:10px;">Name</th>
                                <th style="padding:10px;">Review</th>
                                <th style="padding:10px;">Media</th>
                                <th style="padding:10px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                    <p id="loadingReviews" style="text-align:center; margin-top:20px;">Loading reviews...</p>
                </div>
            </div>

            <div id="tab-gallery" style="display: none;">
                <h1>Manage Gallery</h1>
                
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3>Add New Photos/Videos</h3>
                    <p style="font-size:0.9rem; color:#666;">Hold <strong>Ctrl</strong> (or Command) to select multiple files.</p>
                    <input type="file" id="galleryInput" accept="image/*,video/*" multiple>
                    <button onclick="uploadToGallery()" style="background:#2ed573; color:white; border:none; padding:10px 20px; cursor:pointer;">Upload Selected Files</button>
                    <p id="galleryStatus" style="margin-top:10px; color:#555; font-weight:bold;"></p>
                </div>

                <h3>Current Gallery Items</h3>
                <div id="adminGalleryGrid" class="admin-gallery-grid">
                    </div>
                <p id="loadingGallery" style="text-align:center;">Loading gallery...</p>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDuau7j4CyfotHfMr0svnDY8hp10F3f3M",
            authDomain: "sudipparty-24d31.firebaseapp.com",
            projectId: "sudipparty-24d31",
            storageBucket: "sudipparty-24d31.firebasestorage.app",
            messagingSenderId: "372149822854",
            appId: "1:372149822854:web:ca02d0536a604a31703807"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- AUTH LOGIC ---
        const loginSection = document.getElementById('loginSection');
        const dashboardSection = document.getElementById('dashboardSection');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User Logged In
                loginSection.style.display = 'none';
                dashboardSection.style.display = 'flex';
                loadReviews();
                loadAdminGallery();
                
                // Start Inactivity Timer
                startInactivityTracker();
            } else {
                // User Logged Out
                loginSection.style.display = 'block';
                dashboardSection.style.display = 'none';
                clearTimeout(inactivityTimer);
            }
        });

        // --- INACTIVITY LOGIC (10 Mins) ---
        let inactivityTimer;
        const TIMEOUT_DURATION = 10 * 60 * 1000; 

        function startInactivityTracker() {
            window.onload = resetTimer;
            window.onmousemove = resetTimer;
            window.onmousedown = resetTimer;
            window.ontouchstart = resetTimer;
            window.onclick = resetTimer;
            window.onkeydown = resetTimer;
            window.addEventListener('scroll', resetTimer, true);
            resetTimer(); 
        }

        function resetTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutUser, TIMEOUT_DURATION);
        }

        function logoutUser() {
            if(auth.currentUser) {
                alert("Logged out due to inactivity.");
                signOut(auth);
            }
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                document.getElementById('loginError').style.display = 'block';
                document.getElementById('loginError').innerText = "Login Failed: " + error.message;
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        window.showTab = function(tabName) {
            document.getElementById('tab-reviews').style.display = (tabName === 'reviews') ? 'block' : 'none';
            document.getElementById('tab-gallery').style.display = (tabName === 'gallery') ? 'block' : 'none';
            document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('button').classList.add('active');
        };

        // --- REVIEW MANAGEMENT ---
        async function loadReviews() {
            const tableBody = document.getElementById('adminTableBody');
            const loadingReviews = document.getElementById('loadingReviews');
            tableBody.innerHTML = "";
            
            const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            loadingReviews.style.display = 'none';

            if (snapshot.empty) {
                tableBody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No reviews found.</td></tr>";
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                
                let mediaDisplay = "No Media";
                if (data.mediaURL) {
                    if (data.mediaType === 'video') {
                        mediaDisplay = `
                            <div style="width: 80px; height: 80px; overflow: hidden; border-radius: 5px; cursor: pointer; border: 1px solid #ccc;">
                                <video src="${data.mediaURL}" style="width: 100%; height: 100%; object-fit: cover;" onclick="window.open('${data.mediaURL}')"></video>
                            </div>`;
                    } else {
                        mediaDisplay = `
                            <div style="width: 80px; height: 80px; overflow: hidden; border-radius: 5px; cursor: pointer; border: 1px solid #ccc;">
                                <img src="${data.mediaURL}" style="width: 100%; height: 100%; object-fit: cover;" onclick="window.open('${data.mediaURL}')" alt="Review Image">
                            </div>`;
                    }
                }

                const row = `
                    <tr style="border-bottom:1px solid #eee;">
                        <td style="padding:10px; font-weight:bold;">${data.name}</td>
                        <td style="padding:10px; max-width: 300px;">${data.text}</td>
                        <td style="padding:10px;">${mediaDisplay}</td>
                        <td style="padding:10px;">
                            <button onclick="deleteItem('reviews', '${doc.id}')" style="background: #ff4757; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- GALLERY MANAGEMENT (UPDATED FOR MULTI-UPLOAD) ---
        window.uploadToGallery = async function() {
            const fileInput = document.getElementById('galleryInput');
            const files = fileInput.files; // Get ALL selected files
            const status = document.getElementById('galleryStatus');
            
            if (files.length === 0) { alert("Please select at least one file!"); return; }

            status.innerText = `Uploading ${files.length} file(s)... Please wait.`;

            // Create an array of upload promises
            const uploadPromises = Array.from(files).map(async (file, index) => {
                // Unique name: timestamp + index + filename
                const storageRef = ref(storage, 'gallery/' + Date.now() + '-' + index + '-' + file.name);
                const uploadTask = uploadBytesResumable(storageRef, file);

                return new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', null, 
                        (error) => reject(error), 
                        async () => {
                            const url = await getDownloadURL(uploadTask.snapshot.ref);
                            const type = file.type.startsWith('video/') ? 'video' : 'image';
                            
                            await addDoc(collection(db, "gallery"), {
                                mediaURL: url,
                                mediaType: type,
                                createdAt: serverTimestamp()
                            });
                            resolve(); // This file is done
                        }
                    );
                });
            });

            try {
                // Wait for ALL files to finish uploading
                await Promise.all(uploadPromises);
                
                status.innerText = "All Uploads Successful!";
                status.style.color = "green";
                fileInput.value = ""; // Clear input
                loadAdminGallery(); // Reload grid
                
                // Reset status text after 3 seconds
                setTimeout(() => { status.innerText = ""; status.style.color = "#555"; }, 3000);

            } catch (error) {
                console.error(error);
                status.innerText = "Error uploading some files: " + error.message;
                status.style.color = "red";
            }
        };

        async function loadAdminGallery() {
            const grid = document.getElementById('adminGalleryGrid');
            const loadingGallery = document.getElementById('loadingGallery');
            grid.innerHTML = "";
            
            const q = query(collection(db, "gallery"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            loadingGallery.style.display = 'none';

            snapshot.forEach(doc => {
                const data = doc.data();
                const mediaContent = (data.mediaType === 'video') 
                    ? `<video src="${data.mediaURL}" muted></video>` 
                    : `<img src="${data.mediaURL}">`;

                const item = `
                    <div class="admin-gallery-item">
                        ${mediaContent}
                        <div class="delete-overlay" onclick="deleteItem('gallery', '${doc.id}')">Delete</div>
                    </div>
                `;
                grid.innerHTML += item;
            });
        }

        window.deleteItem = async function(collectionName, id) {
            if(confirm("Are you sure you want to delete this?")) {
                await deleteDoc(doc(db, collectionName, id));
                if(collectionName === 'reviews') loadReviews();
                if(collectionName === 'gallery') loadAdminGallery();
            }
        };

    </script>
</body>
</html>